# 网络库 Echo 回环性能测试报告

## 测试目标

- 在 Benchmark 项目中增加网络库收发基准，使用 `NetUri("tcp://127.0.0.1:7777").CreateRemote()` 建立客户端。
- 服务器回显客户端数据，测量 32 字节包的往返收发耗时与内存分配。
- 对比历史目标：`22,600,000 包/秒`。

## 测试环境

```text
BenchmarkDotNet v0.15.8
Linux Ubuntu 24.04.3 LTS
AMD EPYC 7763, 4 logical cores
.NET SDK 10.0.102
Runtime: .NET 10.0.2, X64 RyuJIT
```

## 测试方法

- 服务端：`EchoNetServer` 监听 `7777`，`OnReceive` 直接 `Send(packet)` 原样回发。
- 客户端：`new NetUri("tcp://127.0.0.1:7777").CreateRemote()`，`client.Open()` 后通过 `client.Send(ReadOnlySpan<Byte>)` 连续发送。
- 基准方法每次总计发送 `200,000` 个 `32B` 包，并等待 `Received` 事件累计到期望字节数后结束。
- 增加并发参数 `Concurrency`，本次实测 `1 / 1000 / 10000`。
- 命令：

```bash
EnableWindowsTargeting=true dotnet run --project Benchmark/Benchmark.csproj -c Release -- --filter "*NetEchoBenchmark*"
```

## 测试结果

| 方法 | PacketSize | Concurrency | Mean | StdDev | Allocated |
|---|---:|---:|---:|---:|---:|
| TCP回环收发 | 32 | 1 | 5,844.2 ns | 162.41 ns | 30 B |
| TCP回环收发 | 32 | 1000 | 577.9 ns | 13.75 ns | 2 B |
| TCP回环收发 | 32 | 10000 | 3,449.4 ns | 54.89 ns | 19 B |

换算：

- Concurrency=1 吞吐：`1 / 5.8442us ≈ 171,110 包/秒`，约 **0.76%** 目标值
- Concurrency=1000 吞吐：`1 / 577.9ns ≈ 1,730,403 包/秒`，约 **7.66%** 目标值
- Concurrency=10000 吞吐：`1 / 3.4494us ≈ 289,905 包/秒`，约 **1.28%** 目标值
- 最高为 `Concurrency=1000`，仍未达到 `22,600,000 包/秒`

## 瓶颈分析

1. **并发度并非越大越快，1000→10000 出现退化**
   - `1000` 并发显著优于 `1`，但 `10000` 并发反而下降，说明超高并发下线程调度和任务切换开销超过收益。
2. **客户端任务调度是明显热点**
   - 当前模型按并发数启动任务并分发发送，`10000` 并发带来更高的调度成本与竞争。
3. **每包一次 Send 调用仍是固定成本**
   - 即使并发提升，`Send` 的调用路径和协议栈处理仍然按包计费，限制上限。
4. **回环路径包含收发双向处理**
   - 测试并非纯发送极限，结果同时受到发送、回调和回包处理影响。

## 改进建议

1. **优先寻找“最佳并发区间”**
   - 以本次结果看，`1000` 已优于 `1` 与 `10000`，建议继续细分测试（如 `256/512/1024/2048`）寻找峰值点。
2. **提升批量发送能力**
   - 引入批量发送接口或应用层聚合发送，减少每包一次发送调用的固定开销。
3. **减少回调路径开销**
   - 在热点路径尽量避免复杂回调逻辑，使用更轻量的计数/无锁汇总策略。
4. **拆分测试维度**
   - 分开测试“单向发送极限”“单向接收极限”“双向回环极限”，定位瓶颈位于发、收还是回调。
5. **粘包利用策略**
   - 在保证业务语义前提下提高单次写入负载，利用 TCP 粘包减少包级调度成本。

## 结论

本次已完成 `1000` 和 `10000` 并发实测。结果显示：并发提升到 `1000` 时吞吐提升明显（约 **173 万包/秒**），继续提升到 `10000` 时出现回落（约 **29 万包/秒**）。当前最优结果仍明显低于 `2260 万包/秒` 目标，后续应重点优化任务调度、批量发送与回调路径，并继续搜索最佳并发窗口。
